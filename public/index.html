<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Kaspa Tweets - Public</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 2rem;
        background: #0f172a;
        color: #e2e8f0;
      }
      a {
        color: #38bdf8;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th,
      td {
        border: 1px solid #1e293b;
        padding: 0.5rem;
        vertical-align: top;
      }
      th {
        background: #1e293b;
      }
      tr:nth-child(odd) {
        background: #0f172a;
      }
      tr:nth-child(even) {
        background: #1e293b;
      }
      select,
      button {
        font: inherit;
        background: #1e293b;
        color: white;
        border: 1px solid #334155;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
      }
      button {
        cursor: pointer;
        background: #3b82f6;
        border-color: #2563eb;
      }
      button:hover {
        background: #2563eb;
      }
      button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }
      .filters {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
      }
      .filters select {
        min-width: 10rem;
      }
      .cell-content {
        max-height: 200px;
        overflow: hidden;
        position: relative;
      }
      .quote .cell-content {
        white-space: pre-line;
      }
      .cell-content.expanded {
        max-height: none;
      }
      .expand-toggle {
        display: inline-block;
        color: #38bdf8;
        cursor: pointer;
        font-size: 0.9em;
        margin-top: 0.125rem;
        text-decoration: underline;
      }
      .expand-toggle:hover {
        color: #0ea5e9;
      }
      #loading {
        display: none;
        color: #94a3b8;
        margin-left: 1rem;
      }
      .pagination {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-top: 1rem;
      }
      .pagination select {
        min-width: auto;
      }
      #results-summary {
        color: #94a3b8;
        margin-left: auto;
      }
    </style>
  </head>
  <body>
    <h1>Kaspa Tweets</h1>

    <div class="filters">
      <label>
        Model approved:
        <select id="filter-approved">
          <option value="all">All</option>
          <option value="true">Approved</option>
          <option value="false">Rejected</option>
        </select>
      </label>
      <label>
        Human decision:
        <select id="filter-human">
          <option value="all">All</option>
          <option value="APPROVED">Approved</option>
          <option value="REJECTED">Rejected</option>
          <option value="UNSET">Unset</option>
        </select>
      </label>
      <button id="refresh-btn">Refresh</button>
      <span id="loading">Loading...</span>
    </div>

    <table>
      <colgroup>
        <col /><!-- ID -->
        <col /><!-- Tweet -->
        <col style="min-width: 20%;" /><!-- Quote -->
        <col /><!-- URL -->
        <col /><!-- Model Approved -->
        <col /><!-- Human Decision -->
        <col /><!-- Date -->
      </colgroup>
      <thead>
        <tr>
          <th>ID</th>
          <th>Tweet</th>
          <th>Quote</th>
          <th>URL</th>
          <th>Model Approved</th>
          <th>Human Decision</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="tweets-body">
        <!-- Tweets will be loaded here -->
      </tbody>
    </table>

    <div class="pagination">
      <div style="display: flex; gap: 0.5rem; align-items: center">
        <button id="prev-page" type="button">Previous</button>
        <span id="page-display">Page 1</span>
        <button id="next-page" type="button">Next</button>
      </div>
      <label>
        Per page:
        <select id="page-size">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
        </select>
      </label>
      <span id="results-summary">Showing 0 of 0</span>
    </div>

    <script>
      const API_BASE = "/api/tweets";
      const tweetsBody = document.getElementById("tweets-body");
      const filterApproved = document.getElementById("filter-approved");
      const filterHuman = document.getElementById("filter-human");
      const refreshBtn = document.getElementById("refresh-btn");
      const loadingIndicator = document.getElementById("loading");
      const prevPageBtn = document.getElementById("prev-page");
      const nextPageBtn = document.getElementById("next-page");
      const pageDisplay = document.getElementById("page-display");
      const pageSizeSelect = document.getElementById("page-size");
      const resultsSummary = document.getElementById("results-summary");

      prevPageBtn.disabled = true;
      nextPageBtn.disabled = true;

      const paginationState = {
        page: 1,
        pageSize: Number(pageSizeSelect.value) || 20,
        totalPages: 0,
        total: 0,
        hasNextPage: false,
        hasPreviousPage: false,
      };

      function applyFiltersFromUrl() {
        const params = new URLSearchParams(window.location.search);
        setSelectFromParam(filterApproved, params.get("approved"));
        setSelectFromParam(filterHuman, params.get("humanDecision"));
        const urlPage = parsePositiveInteger(params.get("page"));
        const urlPageSize = parsePositiveInteger(params.get("pageSize"));

        if (urlPage) {
          paginationState.page = urlPage;
        }

        if (urlPageSize && hasPageSizeOption(urlPageSize)) {
          pageSizeSelect.value = String(urlPageSize);
          paginationState.pageSize = urlPageSize;
        }
      }

      function setSelectFromParam(selectEl, value) {
        if (!value) {
          selectEl.value = "all";
          return;
        }
        const optionExists = Array.from(selectEl.options).some(
          (opt) => opt.value === value
        );
        selectEl.value = optionExists ? value : "all";
      }

      function updateUrlFromFilters() {
        const params = new URLSearchParams(window.location.search);
        syncFilterParam(params, "approved", filterApproved.value);
        syncFilterParam(params, "humanDecision", filterHuman.value);
        params.set("page", String(paginationState.page));
        params.set("pageSize", String(paginationState.pageSize));
        const newSearch = params.toString();
        const newUrl = `${window.location.pathname}${
          newSearch ? `?${newSearch}` : ""
        }${window.location.hash}`;
        window.history.replaceState({}, "", newUrl);
      }

      function syncFilterParam(params, key, value) {
        if (value && value !== "all") {
          params.set(key, value);
        } else {
          params.delete(key);
        }
      }

      function handleFilterChange() {
        paginationState.page = 1;
        updateUrlFromFilters();
        fetchTweets();
      }

      async function fetchTweets() {
        loadingIndicator.style.display = "inline";
        tweetsBody.innerHTML =
          '<tr><td colspan="7" style="text-align:center">Loading...</td></tr>';

        const params = new URLSearchParams();
        if (filterApproved.value !== "all")
          params.append("approved", filterApproved.value);
        if (filterHuman.value !== "all")
          params.append("humanDecision", filterHuman.value);
        params.append("page", String(paginationState.page));
        params.append("pageSize", String(paginationState.pageSize));

        try {
          const res = await fetch(`${API_BASE}?${params.toString()}`);
          if (!res.ok) throw new Error("Failed to fetch tweets");
          const payload = await res.json();
          renderTweets(payload.data || []);
          updatePagination(payload.pagination);
        } catch (err) {
          console.error(err);
          tweetsBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color: #ef4444;">Error loading tweets: ${err.message}</td></tr>`;
        } finally {
          loadingIndicator.style.display = "none";
        }
      }

      function renderTweets(tweets) {
        if (tweets.length === 0) {
          tweetsBody.innerHTML =
            '<tr><td colspan="7" style="text-align:center">No tweets found</td></tr>';
          return;
        }

        tweetsBody.innerHTML = tweets
          .map((tweet) => {
            return `
          <tr>
            <td>${escapeHtml(tweet.id)}</td>
            <td>
              <div class="cell-content" data-content-type="tweet">${escapeHtml(tweet.text)}</div>
              <span class="expand-toggle" data-target="tweet" style="display: none;">Show more</span>
            </td>
            <td class="quote">
              <div class="cell-content" data-content-type="quote">${escapeHtml(tweet.quote)}</div>
              <span class="expand-toggle" data-target="quote" style="display: none;">Show more</span>
            </td>
            <td><a href="${escapeHtml(
              tweet.url
            )}" target="_blank" rel="noreferrer">link</a></td>
            <td class="status-icon">${tweet.approved ? "✅" : "❌"}</td>
            <td>${tweet.humanDecision || "UNSET"}</td>
            <td>${escapeHtml(new Date(tweet.updatedAt || tweet.createdAt).toLocaleString())}</td>
          </tr>
        `;
          })
          .join("");
        setTimeout(updateExpandToggles, 50);
      }

      function escapeHtml(value) {
        if (!value) return "";
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function updatePagination(meta = {}) {
        const page = Number(meta.page) || 1;
        const pageSize = Number(meta.pageSize) || paginationState.pageSize;
        const total = Number(meta.total) || 0;
        const totalPages = Number(meta.totalPages) || 0;
        const hasNext =
          typeof meta.hasNextPage === "boolean"
            ? meta.hasNextPage
            : totalPages !== 0 && page < totalPages;
        const hasPrev =
          typeof meta.hasPreviousPage === "boolean"
            ? meta.hasPreviousPage
            : page > 1;

        paginationState.page = page;
        paginationState.pageSize = pageSize;
        paginationState.total = total;
        paginationState.totalPages = totalPages;
        paginationState.hasNextPage = hasNext;
        paginationState.hasPreviousPage = hasPrev;

        pageDisplay.textContent =
          totalPages > 0 ? `Page ${page} of ${totalPages}` : "Page 1 of 1";
        prevPageBtn.disabled = !hasPrev;
        nextPageBtn.disabled = !hasNext;
        pageSizeSelect.value = String(pageSize);
        resultsSummary.textContent = formatResultsSummary(
          page,
          pageSize,
          total
        );
      }

      function formatResultsSummary(page, pageSize, total) {
        if (total === 0) return "Showing 0 of 0";
        const start = (page - 1) * pageSize + 1;
        if (start > total) return `Showing 0 of ${total}`;
        const end = Math.min(page * pageSize, total);
        return `Showing ${start}-${end} of ${total}`;
      }

      function parsePositiveInteger(value) {
        if (!value) return null;
        const parsed = Number.parseInt(value, 10);
        if (!Number.isFinite(parsed) || parsed <= 0) return null;
        return parsed;
      }

      function hasPageSizeOption(size) {
        return Array.from(pageSizeSelect.options).some(
          (opt) => Number(opt.value) === Number(size)
        );
      }

      prevPageBtn.addEventListener("click", () => {
        if (!paginationState.hasPreviousPage) return;
        paginationState.page -= 1;
        updateUrlFromFilters();
        fetchTweets();
      });

      nextPageBtn.addEventListener("click", () => {
        if (!paginationState.hasNextPage) return;
        paginationState.page += 1;
        updateUrlFromFilters();
        fetchTweets();
      });

      pageSizeSelect.addEventListener("change", () => {
        paginationState.pageSize = Number(pageSizeSelect.value) || 20;
        paginationState.page = 1;
        updateUrlFromFilters();
        fetchTweets();
      });

      tweetsBody.addEventListener("click", (event) => {
        if (event.target.classList.contains("expand-toggle")) {
          handleExpandToggle(event);
        }
      });

      filterApproved.addEventListener("change", handleFilterChange);
      filterHuman.addEventListener("change", handleFilterChange);
      refreshBtn.addEventListener("click", () => {
        updateUrlFromFilters();
        fetchTweets();
      });

      // cell expand/collapse functionality
      function updateExpandToggles() {
        const cells = document.querySelectorAll('.cell-content');
        cells.forEach(cell => {
          const toggle = cell.nextElementSibling;
          if (toggle && toggle.classList.contains('expand-toggle')) {
            const isOverflowing = cell.scrollHeight > cell.clientHeight;
            toggle.style.display = isOverflowing ? 'inline-block' : 'none';
          }
        });
      }

      function handleExpandToggle(event) {
        if (!event.target.classList.contains('expand-toggle')) return;

        const toggle = event.target;
        const cell = toggle.previousElementSibling;
        const isExpanded = cell.classList.contains('expanded');

        if (isExpanded) {
          cell.classList.remove('expanded');
          toggle.textContent = 'Show more';
        } else {
          cell.classList.add('expanded');
          toggle.textContent = 'Show less';
        }
      }

      // initial load
      applyFiltersFromUrl();
      fetchTweets();

      // update expand toggles after tweets are loaded
      setTimeout(updateExpandToggles, 100);
    </script>
  </body>
</html>
